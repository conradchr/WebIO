//***********************************************************************************
//***********************************************************************************
//***********************************************************************************
//***********************************************************************************
//***********************************************************************************
//
//
//
//	deditec_usr_mgr.js
//	project: WEB-I/O
//
//
//	(c) DEDITEC GmbH, 2009-2014
//	web: http://www.deditec.de/
//	mail: vertrieb@deditec.de
//
//
//***********************************************************************************
//***********************************************************************************
//***********************************************************************************
//***********************************************************************************
//***********************************************************************************

if (typeof dt == "undefined") {
	var dt = {};
}

dt.usrmgr = {};

// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------

dt.usrmgr.add = function (username, password, rights, callback) {
	webrequest_send(server_id.usr_mgr, "add " + username, password, webrequest_option.none, error_option.only_alert, function(data, error) {
		if (typeof error != "undefined") {
			callback(error, true);
			return;
		}
		callback("", false);
	});
};

// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------

dt.usrmgr.del = function (username, callback) {
	webrequest_send(server_id.usr_mgr, "del", username, webrequest_option.none, error_option.only_alert, function(data, error) {
		if (typeof error != "undefined") {
			callback(error, true);
			return;
		}
		callback("", false);
	});
};

// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------

dt.usrmgr.list = function (callback, count) {
	this.rdata = {};
	this.count = count;
	this.cb = callback;
	var that = this;
	webrequest_get(server_id.usr_mgr, "first", webrequest_option.none, error_option.only_alert, function(data, error) {
		if (typeof error != "undefined") {
			that.cb(error, true);
			return;
		} else {
			that.count();
			dt.usrmgr.list.rights.call(that, data);
		}
	});
};

// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------

dt.usrmgr.list.next = function () {
	var that = this;
	
	webrequest_get(server_id.usr_mgr, "next", webrequest_option.none, error_option.only_alert, function(data, error) {
		if (typeof error != "undefined" || data == "last") {
			that.cb(that.rdata, false);
			return;
		} else {
			that.count();
			dt.usrmgr.list.rights.call(that, data);
		}
	});
};

// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------

dt.usrmgr.list.rights = function (username) {
	var that = this;
	webrequest_get(server_id.usr_mgr, "get_rights " + username, webrequest_option.none, error_option.only_alert, function(data, error) {
		if (typeof error != "undefined") {
			that.rdata[username] = "none";
		} else {
			that.rdata[username] = data.replace(/[\r\n]/gi, "");
		}
		dt.usrmgr.list.next.call(that, that.cb);
	});
};

// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------

dt.usrmgr.set_rights = function (username, rights, callback) 
{
	rights_array = rights.replace(/[\r\n]/gi, "").split(",");
	
	if ((rights_array.indexOf("IO_wr") > -1) && (rights_array.indexOf("IO_rd") == -1))
	{
		alert("To assign \"IO_wr\", you must also assign \"IO_rd\"");
		return;
	}

		if ((rights_array.indexOf("CONFIG_wr") > -1) && (rights_array.indexOf("CONFIG_rd") == -1))
	{
		alert("To assign \"CONFIG_wr\", you must also assign \"CONFIG_rd\"");
		return;
	}
	
	webrequest_send(server_id.usr_mgr, "set_rights " + username, rights.replace(/[\r\n]/gi, ""), webrequest_option.none, error_option.only_alert, function(data, error) {
		if (typeof error != "undefined") {
			callback(error, true);
			return;
		}
		callback("", false);
	});
};

// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------

dt.usrmgr.set_password = function (username, password, callback) {
	webrequest_send(server_id.usr_mgr, "set_password " + username, password.replace(/[\r\n]/gi, ""), webrequest_option.none, error_option.only_alert, function(data, error) {
		if (typeof error != "undefined") {
			callback(error, true);
			return;
		}
		callback("", false);
	});
};

// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
// ----------------------------------------------------------------------------
